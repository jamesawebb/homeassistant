# Looks like Google have removed the API for this platform.
#- platform: google_wifi

# Cf. https://www.home-assistant.io/components/systemmonitor/
- platform: systemmonitor
  resources:
  - type: disk_use_percent
    arg: /
  - type: memory_use_percent
  - type: swap_use_percent
  - type: last_boot
  - type: load_5m

# Removed in lieu of Glances integration
# # Cf. https://github.com/hassio-addons/addon-glances/blob/v0.5.5/README.md
# - platform: glances
#   host: 127.0.0.1
#   port: 61209
#   version: 3
#   resources:
#     - 'processor_load'
#     - 'memory_use_percent'
#     - 'disk_use_percent'

- platform: github
  access_token: !secret my_github_repo_token
  repositories:
    - path: 'jamesawebb/homeassistant'
    
- platform: alpha_vantage
  api_key: !secret alpha_vantage_key
  symbols:
    - symbol: GOOG
      name: Google Class C
    # - symbol: GOOGL
    #   name: Google Class A
  foreign_exchange:
    - name: usd2aud
      from: USD
      to: AUD

- platform: template
  sensors:
    google_aud:
      friendly_name: "Google stock adjusted to AUD"
      unit_of_measurement: "$AUD"
      value_template: "{{ (float(states('sensor.google_class_c')) * float(states('sensor.usd2aud'))) | round(2)}}"
    solar_angle:
      friendly_name: "Sun Angle"
      unit_of_measurement: '°'
      value_template: "{{ '%+.1f'|format(state_attr('sun.sun', 'elevation')) }}"
    sunrise:
      value_template: "{{ state_attr('sun.sun', 'next_rising') }}"

- platform: mqtt
  name: Bridge state
  state_topic: "zigbee2mqtt/bridge/state"
  icon: mdi:router-wireless

- platform: mqtt
  name: Zigbee2mqtt Networkmap
  # if you change base_topic of Zigbee2mqtt, change state_topic accordingly
  state_topic: zigbee2mqtt/bridge/networkmap/raw
  value_template: >-
    {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
  # again, if you change base_topic of Zigbee2mqtt, change json_attributes_topic accordingly
  json_attributes_topic: zigbee2mqtt/bridge/networkmap/raw

# Frontdoor sensor
- platform: "mqtt"
  state_topic: "zigbee2mqtt/frontdoor"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "%"
  device_class: "battery"
  value_template: "{{ value_json.battery }}"

- platform: "mqtt"
  state_topic: "zigbee2mqtt/frontdoor"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "-"
  value_template: "{{ value_json.linkquality }}"

# Laundry/Kitching sliding door sensor
- platform: "mqtt"
  state_topic: "zigbee2mqtt/laundry_sliding_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "%"
  device_class: "battery"
  value_template: "{{ value_json.battery }}"

- platform: "mqtt"
  state_topic: "zigbee2mqtt/laundry_sliding_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "-"
  value_template: "{{ value_json.linkquality }}"

# Patio sliding door
- platform: "mqtt"
  state_topic: "zigbee2mqtt/patio_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "%"
  device_class: "battery"
  value_template: "{{ value_json.battery }}"

- platform: "mqtt"
  state_topic: "zigbee2mqtt/patio_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "-"
  value_template: "{{ value_json.linkquality }}"

# Patio sliding door
- platform: "mqtt"
  state_topic: "zigbee2mqtt/garage_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "%"
  device_class: "battery"
  value_template: "{{ value_json.battery }}"

- platform: "mqtt"
  state_topic: "zigbee2mqtt/garage_door"
  availability_topic: "zigbee2mqtt/bridge/state"
  unit_of_measurement: "-"
  value_template: "{{ value_json.linkquality }}"

- platform: yr     # Weather prediction

# Cf. https://www.home-assistant.io/components/bom/
- platform: bom
  station: !secret my_bom_station
  name: !secret my_bom_name
  monitored_conditions:
    - apparent_t
    - delta_t
    - gust_kmh
    - gust_kt
    - air_temp
    - dewpt
    - rain_trace
    - rel_hum
    - wind_dir
    - wind_spd_kmh
    - wind_spd_kt

# Cf. https://home-assistant.io/components/sensor.bom_forecast/
# Cf. https://github.com/DavidFW1960/bom_forecast
- platform: bom_forecast
  product_id: !secret my_bom_product_id2
  name: !secret my_bom_name
  forecast_days: 6
  rest_of_today: true
  friendly: false
  friendly_state_format: '{max}, {summary}'
  monitored_conditions:
    - 'chance_of_rain'
    - 'detailed_summary'
    - 'icon'
    - 'max'
    - 'min'
    - 'possible_rainfall'
    - 'summary'
    - 'fire_danger'
    - 'uv_alert'

# Cf. https://www.home-assistant.io/components/mold_indicator/
- platform: mold_indicator
  indoor_temp_sensor: sensor.bedroom_temperature
  indoor_humidity_sensor: sensor.bedroom_relative_humidity
  outdoor_temp_sensor: sensor.outside_patio_temperature
  calibration_factor: 2.0

- platform: template
  sensors:
    bedroom_diff:
      value_template: "{{ (states('sensor.outside_patio_temperature') | float - states('sensor.bedroom_temperature') | float) | round }}"
    lounge_diff:
      value_template: "{{ (states('sensor.outside_patio_temperature') | float - states('sensor.lounge_temperature') | float) | round }}"
    garage_internal_diff:
      value_template: "{{ (states('sensor.garage_temperature') | float - states('sensor.lounge_temperature') | float) | round }}"
    garage_external_diff:
      value_template: "{{ (states('sensor.outside_patio_temperature') | float - states('sensor.garage_temperature') | float) | round }}"

- platform: template
  sensors:
    mould_degrees:
      friendly_name: "Mould Indicator"
      unit_of_measurement: °C
      value_template: "{{ states('sensor.mold_indicator') }}"
    bom_current_text:
      value_template: >
        {% set val = states('sensor.bom_terrey_hills_summary_0').split('.')[0] %} 
        {{ val | title }}
    bom_forecast_0:
      entity_id:
        - sensor.bom_today_max
        - sensor.bom_today_min
        - sensor.bom_terrey_hills_chance_of_rain_0
        - sensor.bom_terrey_hills_icon_0
      friendly_name: "Today"
      value_template: >
        {{states('sensor.bom_today_max')|round(0)}}°/{{states('sensor.bom_today_min')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_0')|round(0)}}%
      entity_picture_template: >-
        {%- if states('sun.sun') == 'below_horizon' and (states('sensor.bom_terrey_hills_icon_0') == 'fog' or states('sensor.bom_terrey_hills_icon_0') == 'haze' or states('sensor.bom_terrey_hills_icon_0') == 'light-showers' or states('sensor.bom_terrey_hills_icon_0') == 'partly-cloudy' or states('sensor.bom_terrey_hills_icon_0') == 'showers') -%}
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_0') ~ '-night.png' }}
        {%- else -%}
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_0') ~ '.png' }}
        {%- endif -%}
    bom_forecast_1:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_1
        - sensor.bom_terrey_hills_min_temp_c_1
        - sensor.bom_terrey_hills_chance_of_rain_1
        - sensor.bom_terrey_hills_icon_1
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (1 * 86400 ) -%}
        {{ date | timestamp_custom('Tomorrow (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_1')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_1')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_1')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_1') ~ '.png' }}
    bom_forecast_2:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_2
        - sensor.bom_terrey_hills_min_temp_c_2
        - sensor.bom_terrey_hills_chance_of_rain_2
        - sensor.bom_terrey_hills_icon_2
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (2 * 86400 ) -%}
        {{ date | timestamp_custom('%A (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_2')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_2')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_2')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_2') ~ '.png' }}
    bom_forecast_3:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_3
        - sensor.bom_terrey_hills_min_temp_c_3
        - sensor.bom_terrey_hills_chance_of_rain_3
        - sensor.bom_terrey_hills_icon_3
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (3 * 86400 ) -%}
        {{ date | timestamp_custom('%A (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_3')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_3')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_3')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_3') ~ '.png' }}
    bom_forecast_4:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_4
        - sensor.bom_terrey_hills_min_temp_c_4
        - sensor.bom_terrey_hills_chance_of_rain_4
        - sensor.bom_terrey_hills_icon_4
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (4 * 86400 ) -%}
        {{ date | timestamp_custom('%A (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_4')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_4')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_4')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_4') ~ '.png' }}
    bom_forecast_5:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_5
        - sensor.bom_terrey_hills_min_temp_c_5
        - sensor.bom_terrey_hills_chance_of_rain_5
        - sensor.bom_terrey_hills_icon_5
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (5 * 86400 ) -%}
        {{ date | timestamp_custom('%A (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_5')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_5')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_5')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_5') ~ '.png' }}
    bom_forecast_6:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_6
        - sensor.bom_terrey_hills_min_temp_c_6
        - sensor.bom_terrey_hills_chance_of_rain_6
        - sensor.bom_terrey_hills_icon_6
      friendly_name_template: >
        {%- set date = as_timestamp(now()) + (6 * 86400 ) -%}
        {{ date | timestamp_custom('%A (%-d/%-m)') }}
      value_template: >
        {{states('sensor.bom_terrey_hills_max_temp_c_6')|round(0)}}°/{{states('sensor.bom_terrey_hills_min_temp_c_6')|round(0)}}°/{{states('sensor.bom_terrey_hills_chance_of_rain_6')|round(0)}}%
      entity_picture_template: >-
        {{ '/local/icons/bom_icons/' ~ states('sensor.bom_terrey_hills_icon_6') ~ '.png' }}
    bom_today_max:
      entity_id:
        - sensor.bom_terrey_hills_max_temp_c_0
        - sensor.today_temp_bom_mean
      value_template: >
        {%- if states('sensor.bom_terrey_hills_max_temp_c_0') == 'n/a' -%} 
          {{ state_attr('sensor.today_temp_bom_mean', 'max_value') }}
        {% else %}
          {{ states('sensor.bom_terrey_hills_max_temp_c_0') }}
        {% endif %}
    bom_today_min:
      entity_id:
        - sensor.bom_terrey_hills_min_temp_c_0
        - sensor.today_temp_bom_mean
      value_template: >
        {%- if states('sensor.bom_terrey_hills_min_temp_c_0') == 'n/a' -%} 
          {{ state_attr('sensor.today_temp_bom_mean', 'min_value') }}
        {% else %}
          {{ states('sensor.bom_terrey_hills_min_temp_c_0') }}
        {% endif %}
    bom_uv_alert:
      value_template: >
        {%- if states('sensor.bom_terrey_hills_uv_alert_0') != 'n/a' -%} 
        UV Today: {{ states('sensor.bom_terrey_hills_uv_alert_0') }}
        {%- else -%}
        UV Tomorrow: {{ states('sensor.bom_terrey_hills_uv_alert_1') }}
        {%- endif -%}

    bom_uv_alert_summary:
      value_template: >
        {% set val = states('sensor.bom_uv_alert').split('[')[1].split(']')[0]%}
        {{ val | title }}

    bom_fire_danger:
      value_template: >
        {%- if states('sensor.bom_terrey_hills_fire_danger_0') != 'n/a' -%} 
        Fire Danger Today: {{ states('sensor.bom_terrey_hills_fire_danger_0') }}
        {%- else -%}
        Fire Danger Tomorrow: {{ states('sensor.bom_terrey_hills_fire_danger_1') }}
        {%- endif -%}

    bom_fire_danger_summary:
      value_template: >
        {%- if states('sensor.bom_terrey_hills_fire_danger_0') != 'n/a' -%} 
        {{ states('sensor.bom_terrey_hills_fire_danger_0') }}
        {%- else -%}
        {{ states('sensor.bom_terrey_hills_fire_danger_1') }}
        {%- endif -%}

- platform: statistics
  name: today_temp_bom
  sampling_size: 150
  entity_id: sensor.bom_terrey_hills_air_temp_c
  max_age:
    hours: 24

- platform: apcupsd
  resources:
    - apc
    - date
    - hostname
    - version
    - upsname
    - cable
    - driver
    - upsmode
    - starttime
    - model
    - status
    - linev
    - loadpct
    - bcharge
    - timeleft
    - mbattchg
    - mintimel
    - maxtime
    # - maxlinev
    # - minlinev
    - outputv

# Cf. https://www.waternsw.com.au/water-quality/catchment/sub-catchment/warragamba
- platform: waternsw
  name: Warragamba Dam
  site_id: 212243
  from_variable: 130.00
  to_variable: 136.00
  unit_of_measure: ML

# Cf. https://www.waternsw.com.au/water-quality/catchment/sub-catchment/nepean
- platform: waternsw
  name: Nepean Dam
  site_id: 212205
  from_variable: 132.00
  to_variable: 132.00
  unit_of_measure: ML

- platform: season
